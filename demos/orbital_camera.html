<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Hopper Demo | Orbital Camera</title>
    <link rel="stylesheet" href="../styles/canvas.css">
    <link rel="stylesheet" href="../styles/message.css">
    <link rel="stylesheet" href="../styles/debug.css">
    <link rel="stylesheet" href="../styles/loadscreen.css">
    <link rel="stylesheet" href="../styles/tutorial.css">
    <link rel="apple-touch-icon" sizes="57x57" href="../resources/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="../resources/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../resources/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../resources/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../resources/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../resources/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="../resources/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../resources/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../resources/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="../resources/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../resources/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../resources/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../resources/favicon-16x16.png">
    <link rel="manifest" href="../resources/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="../resources/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
</head>
<body>
    <canvas id="render-output"></canvas>
    <pre id="render-message"></pre>
    <div class="render-debug-left">
        <div class="render-debug-container">
            <h1 class="render-debug-header">Info</h1>
            <p id="hopper-webgl-version" class="render-debug-info">WebGL version: </p>
            <p id="hopper-webgl-debug-mode" class="render-debug-info">Debug mode: </p>
            <p id="hopper-webgl-antialias" class="render-debug-info">Antialiasing: </p>
            <p id="hopper-webgl-stencil" class="render-debug-info">Stencil: </p>
            <p id="hopper-webgl-power" class="render-debug-info">Power preference: </p>
            <p id="hopper-webgl-extension-count" class="render-debug-info">Extension count: </p>
            <p id="hopper-webgl-vao" class="render-debug-info">VAO support: </p>
            <p id="hopper-webgl-index-uint" class="render-debug-info">32-bit index support: </p>
            <p id="hopper-webgl-anisotropy" class="render-debug-info">Anisotropy support: </p>
            <p id="hopper-webgl-anisotropy-max" class="render-debug-info">Max anisotropy: 0</p>
            <p id="hopper-webgl-fragment-shader-precision" class="render-debug-info">Fragment float precision: </p>
            <p id="hopper-webgl-vertex-shader-precision" class="render-debug-info">Vertex float precision: </p>
            <p id="hopper-webgl-max-texture-size" class="render-debug-info">Max texture size: </p>
        </div>
        <div class="render-debug-container">
            <h1 class="render-debug-header">Performance</h1>
            <p id="hopper-performance-real-ms" class="render-debug-info">Real ms: </p>
            <p id="hopper-performance-real-fps" class="render-debug-info">Real fps: </p>
            <p id="hopper-performance-effective-ms" class="render-debug-info">Effective ms: </p>
            <p id="hopper-performance-effective-fps" class="render-debug-info">Effective fps: </p>
        </div>
    </div>
    <div class="render-debug-right">
        <div class="render-debug-container">
            <h1 class="render-debug-header">Main Camera</h1>
            <p id="hopper-camera-position" class="render-debug-info">Position: </p>
            <p id="hopper-camera-direction" class="render-debug-info">Direction: </p>
            <p id="hopper-camera-target" class="render-debug-info">Target: </p>
            <p id="hopper-camera-orientation" class="render-debug-info">Orientation: </p>
            <p id="hopper-camera-rotation-speed" class="render-debug-info">Rotation speed: </p>
            <p id="hopper-camera-rotation-smoothing" class="render-debug-info">Rotation smoothing: </p>
            <p id="hopper-camera-distance-delta-multiplier" class="render-debug-info">Distance delta multiplier: </p>
            <p id="hopper-camera-distance-smoothing" class="render-debug-info">Distance smoothing: </p>
            <p id="hopper-camera-fovy" class="render-debug-info">Vertical field of view: </p>
            <p id="hopper-camera-near" class="render-debug-info">Near: </p>
            <p id="hopper-camera-far" class="render-debug-info">Far: </p>
            <p id="hopper-camera-aspect" class="render-debug-info">Aspect ratio: </p>
        </div>
    </div>
    <h1 class="render-title">Hopper v0.1.0 | Orbital Camera</h1>
    <div id="hopper-tutorial" style="height: 300px;">
        <strong class="hopper-tutorial-title">Tutorial</strong>
        <p class="hopper-tutorial-content">
            <ul class="hopper-tutorial-content-list">
                <li class="hopper-tutorial-content-list-elem">Click on the page to activate camera</li>
                <li class="hopper-tutorial-content-list-elem">Press escape to deactivate camera</li>
                <li class="hopper-tutorial-content-list-elem">Move mouse to rotate camera</li>
                <li class="hopper-tutorial-content-list-elem">Hold A to roll left</li>
                <li class="hopper-tutorial-content-list-elem">Hold D to roll right</li>
                <li class="hopper-tutorial-content-list-elem">Use scrollwheel to zoom in/out</li>
            </ul>
        </p>
        <button class="hopper-tutorial-close-btn" onclick="document.getElementById('hopper-tutorial').style.display='none'">Close</button>
    </div>
    <div id="hopper-loading-screen">
        <p class="hopper-loading-screen-title">Hopper Engine</p>
        <img src="../resources/hopper_logo_dark.png" width="256px" height="auto" class="hopper-logo">
        <p class="hopper-loading-screen-message">Loading. Please wait.</p>
    </div>
    <script type="module">

        import {Hopper} from "../src/renderer.js";

        try {
            const hopper = Hopper({
                canvasID: "render-output",
                enableDebug: true,
                debugRefreshDelay: 1000,
                forceWebGL1: false,
                antialias: true,
                stencil: true,
                powerPreference: "high-performance",
                failIfMajorPerformanceCaveat: true
            });

            const Common = hopper.Common;
            const Vec2 = hopper.Vec2;
            const Vec3 = hopper.Vec3;
            const Vec4 = hopper.Vec4;
            const Quat = hopper.Quat;
            const Transform = hopper.Transform;
            const Mat4 = hopper.Mat4;
            const Mat3 = hopper.Mat3;

            const orbitalCamera = hopper.createOrbitalCamera({
                elemID: "render-output",
                position: Vec3(0, 2, 5),
                target: Vec3(0, 0, 0),
                rotationSpeed: 0.05,
                rotationSmoothing: 0.01,
                distanceDeltaMultiplier: 0.001,
                distanceSmoothing: 0.01,
                fovy: Common.toRadians(90.0),
                near: 0.3,
                far: 1000.0,
                aspectRatio: hopper.getAspect(),
                enableDebug: true
            });

            const texture2DLoader = hopper.createTexture2DLoader();
            const floorTexture = texture2DLoader.loadCheckerboard({
                darkColor: Vec4(50, 50, 50, 1.0),
                brightColor: Vec4(200, 200, 200, 1.0),
                minf: "nearest",
                magf: "nearest",
                wraps: "repeat",
                wrapt: "repeat",
                mipmap: false,
                anisotropy: 0
            });
            const cubeTexture = texture2DLoader.loadCheckerboard({
                darkColor: Vec4(25, 50, 75, 1.0),
                brightColor: Vec4(200, 220, 240, 1.0),
                minf: "nearest",
                magf: "nearest",
                wraps: "repeat",
                wrapt: "repeat",
                mipmap: false,
                anisotropy: 0
            });
            const sphereTexture = texture2DLoader.loadCheckerboard({
                darkColor: Vec4(75, 50, 25, 1.0),
                brightColor: Vec4(240, 220, 200, 1.0),
                minf: "nearest",
                magf: "nearest",
                wraps: "repeat",
                wrapt: "repeat",
                mipmap: false,
                anisotropy: 0
            });
            const prismTexture = texture2DLoader.loadCheckerboard({
                darkColor: Vec4(25, 75, 25),
                brightColor: Vec4(180, 220, 180),
                minf: "nearest",
                magf: "nearest",
                wraps: "repeat",
                wrapt: "repeat",
                mipmap: false,
                anisotropy: 0
            });

            hopper.enableDepth();
            hopper.enableCulling();

            hopper.clearColor(Vec4(0.2, 0.3, 0.3, 1.0));

            const phongProgram = hopper.createPhongTextureProgram();
            const basicColorProgram = hopper.createBasicColorProgram();

            const floor = hopper.createRectangle(phongProgram);
            const cube = hopper.createCube(phongProgram);
            const sphere = hopper.createCubeSphere(phongProgram, 1.0, 3);
            const prism = hopper.createPrism(phongProgram, 0.5, 0.5, 2.0, 30, 30);
            const ball = hopper.createIcoSphere(basicColorProgram, 0.5, 3);

            hopper.bindPhongMaterialUBO();
            hopper.setPhongMaterial({ ambient: Vec3(1.0, 1.0, 1.0),
                                      diffuse: Vec3(1.0, 1.0, 1.0),
                                      specular: Vec3(1.0, 1.0, 1.0),
                                      shininess: 16.0 });
            hopper.unbindPhongMaterialUBO();

            hopper.bindDirLightUBO();
            hopper.setDirLight(0, { ambient: Vec3(0.1, 0.1, 0.1),
                                    diffuse: Vec3(1.0, 1.0, 1.0),
                                    specular: Vec3(1.0, 1.0, 1.0), 
                                    direction: Vec3(0.0, 0.0, -1.0),
                                    intensity: 0.0 });
            hopper.unbindDirLightUBO();

            hopper.turnOffLoadingScreen();

            let rotY = 0;
            hopper.render(dt => {
                orbitalCamera.setAspectRatio(hopper.getAspect());
                orbitalCamera.update(dt);

                const projection = orbitalCamera.getProjectionMatrix();
                const view = orbitalCamera.getViewMatrix();

                rotY += dt * 0.001;

                const { linear, quadratic } = Common.genAttenuationFromRange(100.0);

                const pointLightPos = Vec3(4.0 * Math.cos(rotY), 3.0, 4.0 * Math.sin(rotY), 0.0);
                const pointLightColor = Vec3((Math.cos(rotY) + 0.5) * 0.5, (Math.sin(rotY) + 0.5) * 0.5, 1.0);

                hopper.bindPointLightUBO();
                hopper.setPointLight(0, { diffuse: pointLightColor,
                                          specular: pointLightColor,
                                          position: view.mulVec3(pointLightPos),
                                          constant: 1.0,
                                          linear: linear,
                                          quadratic: quadratic,
                                          intensity: 1.0 });
                hopper.unbindPointLightUBO();

                hopper.resize();
                hopper.clear();

                phongProgram.use();

                phongProgram.updateProjection(projection);

                phongProgram.updateAmbientTexTransform(Vec2(0.0, 0.0));
                phongProgram.updateAmbientTexMultiplier(Vec2(10.0, 10.0));

                phongProgram.updateDiffuseTexTransform(Vec2(0.0, 0.0));
                phongProgram.updateDiffuseTexMultiplier(Vec2(10.0, 10.0));

                phongProgram.updateSpecularTexTransform(Vec2(0.0, 0.0));
                phongProgram.updateSpecularTexMultiplier(Vec2(10.0, 10.0));

                {
                    const model = Transform.fromRotationTranslationScale(Quat().setAxisAngle(Vec3(1.0, 0.0, 0.0), Common.toRadians(-90.0)),
                                                                         Vec3(0.0, 0.0, 0.0),
                                                                         Vec3(10.0, 10.0, 1.0));
                    const normal = Transform.normalMat3FromMat4(view.mul(model));

                    phongProgram.updateModelView(view.mul(model));
                    phongProgram.updateNormal(normal);

                    phongProgram.setTextures({
                        ambient: floorTexture,
                        diffuse: floorTexture,
                        specular: floorTexture
                    });

                    floor.bind();
                    floor.draw();
                }

                {
                    const model = Transform.fromRotationTranslationScale(Quat().setAxisAngle(Vec3(0.0, 1.0, 0.0), rotY),
                                                                         Vec3(0.0, 1.0, 0.0),
                                                                         Vec3(1.0, 1.0, 1.0));
                    const normal = Transform.normalMat3FromMat4(view.mul(model));

                    phongProgram.updateModelView(view.mul(model));
                    phongProgram.updateNormal(normal);

                    phongProgram.setTextures({
                        ambient: cubeTexture,
                        diffuse: cubeTexture,
                        specular: cubeTexture
                    });

                    cube.bind();
                    cube.draw();
                }

                {
                    const model = Transform.fromRotationTranslationScale(Quat().setAxisAngle(Vec3(0.0, 1.0, 0.0), rotY),
                                                                         Vec3(-2.5, 1.0, 0.0),
                                                                         Vec3(0.75, 0.75, 0.75));
                    const normal = Transform.normalMat3FromMat4(view.mul(model));

                    phongProgram.updateModelView(view.mul(model));
                    phongProgram.updateNormal(normal);

                    phongProgram.setTextures({
                        ambient: sphereTexture,
                        diffuse: sphereTexture,
                        specular: sphereTexture
                    });

                    sphere.bind();
                    sphere.draw();
                }

                {
                    const model = Transform.fromRotationTranslationScale(Quat().setAxisAngle(Vec3(0.0, 1.0, 0.0), rotY),
                                                                         Vec3(2.5, 1.0, 0.0),
                                                                         Vec3(0.75, 0.75, 0.75));
                    const normal = Transform.normalMat3FromMat4(view.mul(model));

                    phongProgram.updateModelView(view.mul(model));
                    phongProgram.updateNormal(normal);

                    phongProgram.setTextures({
                        ambient: prismTexture,
                        diffuse: prismTexture,
                        specular: prismTexture
                    });

                    prism.bind();
                    prism.draw();
                }

                basicColorProgram.use();
                basicColorProgram.updateProjection(projection);

                {
                    const model = Transform.fromRotationTranslationScale(Quat(),
                                                                         pointLightPos,
                                                                         Vec3(0.2, 0.2, 0.2));
                    basicColorProgram.updateModelView(view.mul(model));
                    basicColorProgram.updateColor(Vec4(pointLightColor.getR(), pointLightColor.getG(), pointLightColor.getB(), 1.0));
                    ball.bind();
                    ball.draw();
                }
            });
        }
        catch (e) {
            document.getElementById("hopper-loading-screen").style.display = "none";
            document.getElementById("render-message").innerHTML = e.toString();
            console.log(e.toString());
            throw e;
        }

    </script>
</body>
</html>
